<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>B√ìR·∫û√ï√ë Chat Support</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* üé® WhatsApp Style CSS */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #e5ddd5; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- Header --- */
        .header { background-color: #008069; color: white; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; height: 60px; z-index: 100; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #ccc; background-size: cover; background-position: center; }
        .chat-info h3 { font-size: 16px; font-weight: 500; margin: 0; }
        .chat-info p { font-size: 12px; opacity: 0.8; margin: 0; }
        .back-btn { display: none; font-size: 20px; cursor: pointer; margin-right: 10px; }

        /* --- Chat Area --- */
        #chat-container { flex: 1; overflow-y: auto; padding: 10px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-repeat: repeat; display: flex; flex-direction: column; gap: 5px; }
        
        /* --- Message Bubbles --- */
        .msg { max-width: 75%; padding: 8px 10px; border-radius: 8px; font-size: 14.5px; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); margin-bottom: 5px; }
        .msg.sent { background-color: #dcf8c6; align-self: flex-end; border-top-right-radius: 0; }
        .msg.received { background-color: white; align-self: flex-start; border-top-left-radius: 0; }
        .msg img { max-width: 100%; border-radius: 5px; margin-top: 5px; display: block; }
        .time { font-size: 10px; color: #999; text-align: right; margin-top: 2px; display: block; }

        /* --- Input Area --- */
        .input-area { background: #f0f0f0; padding: 5px 10px; display: flex; align-items: center; gap: 8px; min-height: 60px; }
        .input-area input { flex: 1; padding: 10px 15px; border-radius: 20px; border: none; outline: none; font-size: 15px; background: white; }
        .icon-btn { font-size: 20px; color: #555; padding: 10px; cursor: pointer; }
        .send-btn { background: #008069; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; font-size: 18px; cursor: pointer; }

        /* --- Admin User List (Only for you) --- */
        #admin-panel { display: none; flex: 1; background: white; overflow-y: auto; }
        .user-item { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 15px; cursor: pointer; transition: 0.2s; }
        .user-item:hover { background: #f5f5f5; }
        .user-item .avatar { background: #008069; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .unread-dot { width: 10px; height: 10px; background: red; border-radius: 50%; margin-left: auto; display: none; }
        .active-user { background-color: #e8f5e9; }

        /* --- Modal (Login) --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-box { background: white; padding: 25px; border-radius: 10px; width: 85%; max-width: 350px; text-align: center; }
        .modal-box input { width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #ddd; border-radius: 5px; }
        .modal-box button { background: #008069; color: white; border: none; padding: 10px 20px; border-radius: 5px; width: 100%; font-size: 16px; }

        /* Helpers */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loginModal" class="modal">
        <div class="modal-box">
            <h2 style="color: #008069;">‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ!</h2>
            <p>‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</p>
            <input type="text" id="usernameInput" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ...">
            <button onclick="startApp()">‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <p style="font-size: 10px; margin-top: 10px; color: #888;">üîí End-to-End Secure Chat</p>
        </div>
    </div>

    <div class="header">
        <div class="header-left">
            <i class="fas fa-arrow-left back-btn" id="backBtn" onclick="goBackToAdmin()"></i>
            <div class="avatar" id="headerAvatar" style="background-image: url('https://cdn-icons-png.flaticon.com/512/149/149071.png');"></div>
            <div class="chat-info">
                <h3 id="headerName">B√ìR·∫û√ï√ë (Admin)</h3>
                <p id="headerStatus">online</p>
            </div>
        </div>
    </div>

    <div id="admin-panel">
        </div>

    <div id="chat-container"></div>

    <div class="input-area" id="inputSection">
        <label for="imgInput">
            <i class="fas fa-camera icon-btn"></i>
        </label>
        <input type="file" id="imgInput" accept="image/*" hidden onchange="handleImage(this)">
        
        <input type="text" id="msgInput" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." onkeypress="if(event.key==='Enter') sendMessage()">
        
        <button class="send-btn" onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>

    <script>
        // üî¥üî¥ ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ FIREBASE CONFIG ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¨‡¶∏‡¶æ‡¶ì üî¥üî¥
        const firebaseConfig = {
            apiKey: "AIzaSyBEiUjtqLlT_cMCE0ba9mweak5QQp915vQ",
            authDomain: "borson-chat-web.firebaseapp.com",
            databaseURL: "https://borson-chat-web-default-rtdb.firebaseio.com",
            projectId: "borson-chat-web",
            storageBucket: "borson-chat-web.firebasestorage.app",
            messagingSenderId: "694928126106",
            appId: "1:694928126106:web:d02ab12ed214accd335528"
        };

        // Firebase Init
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Variables
        let myName = "";
        let myID = localStorage.getItem("myChatID") || "user_" + Date.now();
        localStorage.setItem("myChatID", myID); // ID ‡¶∏‡ßá‡¶≠ ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶Ø‡¶æ‡¶§‡ßá ‡¶™‡ßá‡¶ú ‡¶∞‡¶ø‡¶≤‡ßã‡¶° ‡¶¶‡¶ø‡¶≤‡ßá ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶®‡¶æ ‡¶π‡¶æ‡¶∞‡¶æ‡ßü
        
        let isAdmin = false;
        let currentChatUser = null; // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ø‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ï‡¶∞‡¶õ‡ßá

        // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∂‡ßÅ‡¶∞‡ßÅ
        function startApp() {
            const inputName = document.getElementById('usernameInput').value.trim();
            if (!inputName) return alert("‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá!");

            myName = inputName;
            document.getElementById('loginModal').style.display = 'none';

            // üîê ‡¶∏‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶≤‡¶ó‡¶á‡¶® (‡¶®‡¶æ‡¶Æ ‡¶Ø‡¶¶‡¶ø 'admin123' ‡¶π‡ßü)
            if (myName === "borson_admin") {
                isAdmin = true;
                setupAdminView();
            } else {
                setupUserView();
            }
        }

        // --- üë§ ‡¶´‡ßç‡¶Ø‡¶æ‡¶®‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™ ---
        function setupUserView() {
            // ‡¶´‡ßç‡¶Ø‡¶æ‡¶® ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá
            // ‡¶´‡ßç‡¶Ø‡¶æ‡¶®‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø 'currentChatUser' ‡¶π‡¶≤‡ßã 'admin' (‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶§‡¶æ‡¶∞ ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ID ‡¶§‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡¶¨‡ßá)
            loadMessages(myID);
            
            // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            db.ref('users/' + myID).update({
                name: myName,
                lastMsg: "Joined chat",
                time: Date.now()
            });
        }

        // --- üëë ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™ ---
        function setupAdminView() {
            document.getElementById('chat-container').classList.add('hidden');
            document.getElementById('inputSection').classList.add('hidden');
            document.getElementById('admin-panel').style.display = 'block';
            document.getElementById('headerName').innerText = "Inbox List";
            document.getElementById('headerStatus').innerText = "Select a fan to chat";
            document.getElementById('headerAvatar').style.display = 'none';

            // ‡¶∏‡¶¨ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
            db.ref('users').on('value', (snapshot) => {
                const list = document.getElementById('admin-panel');
                list.innerHTML = "";
                
                snapshot.forEach((child) => {
                    const uData = child.val();
                    const uid = child.key;

                    const div = document.createElement('div');
                    div.className = 'user-item';
                    div.innerHTML = `
                        <div class="avatar">${uData.name.charAt(0).toUpperCase()}</div>
                        <div>
                            <h4>${uData.name}</h4>
                            <p style="font-size:12px; color:#666;">${uData.lastMsg || 'No message'}</p>
                        </div>
                    `;
                    div.onclick = () => openChatAsAdmin(uid, uData.name);
                    list.appendChild(div);
                });
            });
        }

        // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ø‡¶ñ‡¶® ‡¶ï‡ßã‡¶®‡ßã ‡¶´‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶∞ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡¶¨‡ßá
        function openChatAsAdmin(uid, name) {
            currentChatUser = uid; // ‡¶è‡¶ñ‡¶® ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶è‡¶á ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ID ‡¶§‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßã
            
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('chat-container').classList.remove('hidden');
            document.getElementById('inputSection').classList.remove('hidden');
            document.getElementById('backBtn').style.display = 'block';
            document.getElementById('headerAvatar').style.display = 'block';
            document.getElementById('headerName').innerText = name;
            
            loadMessages(uid);
        }

        // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶ì‡ßü‡¶æ
        function goBackToAdmin() {
            currentChatUser = null;
            setupAdminView();
            document.getElementById('backBtn').style.display = 'none';
        }

        // --- üì© ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶è‡¶¨‡¶Ç ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ---
        
        let msgListenerRef = null;

        function loadMessages(chatPathID) {
            const chatBox = document.getElementById('chat-container');
            chatBox.innerHTML = ""; // ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞
            
            if (msgListenerRef) msgListenerRef.off(); // ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß

            msgListenerRef = db.ref('messages/' + chatPathID);
            
            msgListenerRef.limitToLast(50).on('child_added', (snap) => {
                const data = snap.val();
                
                // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ü‡¶æ ‡¶ï‡¶ø ‡¶Ü‡¶Æ‡¶ø ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡¶ø?
                // ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶Æ‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶π‡¶á, ‡¶è‡¶¨‡¶Ç sender 'Admin' ‡¶π‡ßü -> Sent
                // ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶Æ‡¶ø ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶π‡¶á, ‡¶è‡¶¨‡¶Ç sender ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶π‡ßü -> Sent
                let isMe = false;
                if (isAdmin && data.sender === 'Admin') isMe = true;
                if (!isAdmin && data.sender !== 'Admin') isMe = true;

                const div = document.createElement('div');
                div.className = `msg ${isMe ? 'sent' : 'received'}`;
                
                let content = data.text;
                if (data.type === 'image') {
                    content = `<img src="${data.text}" onclick="window.open(this.src)">`;
                }

                div.innerHTML = `
                    ${content}
                    <span class="time">${new Date(data.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                `;
                chatBox.appendChild(div);
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        function sendMessage() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            
            // ‡¶ï‡ßã‡¶•‡¶æ‡ßü ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßã?
            // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶π‡¶≤‡ßá -> currentChatUser ‡¶è‡¶∞ ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞‡ßá
            // ‡¶´‡ßç‡¶Ø‡¶æ‡¶® ‡¶π‡¶≤‡ßá -> myID ‡¶è‡¶∞ ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞‡ßá
            const targetID = isAdmin ? currentChatUser : myID;

            if (!targetID) return; 

            if (text) {
                pushMessage(targetID, text, 'text');
                input.value = "";
            }
        }

        function handleImage(input) {
            const file = input.files[0];
            if (!file) return;

            // ‡¶á‡¶Æ‡ßá‡¶ú ‡¶õ‡ßã‡¶ü ‡¶ï‡¶∞‡¶æ (‡¶ï‡¶Æ‡¶™‡ßç‡¶∞‡ßá‡¶∂‡¶®) ‡¶Ø‡¶æ‡¶§‡ßá ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶´‡¶æ‡¶∏‡ßç‡¶ü ‡¶•‡¶æ‡¶ï‡ßá
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏ ‡¶∏‡¶æ‡¶á‡¶ú ‡ß´‡ß¶‡ß¶px
                    const maxWidth = 500; 
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Base64 ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Ç ‡¶™‡¶æ‡¶ì‡ßü‡¶æ
                    const base64Str = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
                    const targetID = isAdmin ? currentChatUser : myID;
                    pushMessage(targetID, base64Str, 'image');
                }
            }
            reader.readAsDataURL(file);
        }

        function pushMessage(pathID, content, type) {
            const senderName = isAdmin ? "Admin" : myName;
            
            db.ref('messages/' + pathID).push({
                text: content,
                sender: senderName,
                type: type, // 'text' or 'image'
                time: Date.now()
            });

            // ‡¶≤‡¶æ‡¶∏‡ßç‡¶ü ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ (‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
            db.ref('users/' + pathID).update({
                lastMsg: type === 'image' ? 'Sent a photo üì∑' : (isAdmin ? 'You: ' + content : content),
                time: Date.now()
            });
        }

    </script>
</body>
</html>
